# Zeek-Parser-CCLinkIENoIP

## Overview

Zeek-Parser-CCLinkIENoIP is a Zeek plug-in that can analyze CC-Link IE Field, CC-Link IE Control and TSN frame in CC-Link IE TSN of the [CC-Link family](https://www.cc-link.org/ja/cclink/index.html).

## Installation

### Manual Installation

Before using this plug-in, please make sure Zeek, Spicy has been installed.

````
# Check Zeek
~$ zeek -version
zeek version 5.0.0

# Check Spicy
~$ spicyz -version
1.3.16
~$ spicyc -version
spicyc v1.5.0 (d0bc6053)

# The path of zeek in this manual is based on the following output
~$ which zeek
/usr/local/zeek/bin/zeek
````

Use `git clone` to get a copy of this repository to your local environment.
```
~$ git clone https://github.com/nttcom/zeek-parser-CCLinkIENoIP.git
```

## Usage

### For manual installation

Compile source code and copy the object files to the following path.
```
~$ cd ~/zeek-parser-CCLinkIENoIP/analyzer
~$ spicyz -o cc_link_noip.hlto cc_link_noip.spicy cc_link_noip.evt
# cc_link_noip.hlto is generated
~$ cp cc_link_noip.hlto /usr/local/zeek/lib/zeek-spicy/modules/
```

Then, copy the zeek file to the following paths.
```
~$ cd ~/zeek-parser-CCLinkIENoIP/scripts/
~$ cp main.zeek /usr/local/zeek/share/zeek/site/cc_link_noip.zeek
```

Finally, import the Zeek plugin.
```
~$ tail /usr/local/zeek/share/zeek/site/local.zeek
... Omit ...
@load cc_link_noip
```

This plug-in generates a `cclink-ie.log` by the command below:
```
~$ cd ~/zeek-parser-CCLinkIENoIP/testing/Traces
~$ zeek -Cr test1.pcap /usr/local/zeek/share/zeek/site/cc_link_noip.zeek
```

If a pcap file contains tsn frame packets, `cclink-ie-tsn.log` is also generated by the command below:
```
~$ zeek -Cr test2.pcap /usr/local/zeek/share/zeek/site/cc_link_noip.zeek
```

## Log type and description

### For CC-Link IE Field and CC-Link IE Control

It outputs as `cclink-ie.log`.

| Field | Type | Description |
| --- | --- | --- |
| ts | time | timestamp of the first communication |
| src_mac | string | source MCA address |
| dst_mac | string | destination MCA address |
| service | string | protocol name |
| pdu_type | string | protocol function name |
| cmd | string | specific fields for transient1 and transient2 |
| node_type | string | node type |
| node_id | int | node identifier |
| connection_info | string | Identifier of transientData |
| src_node_number | string | own-node-number |
| number | int | number of packet occurrence |
| ts_end | time | Timestamp of the last communication |

An example of `cclink-ie.log` is as follows:
```
#separator \x09
#set_separator .
#empty_field (empty)
#unset_field -
#path cclink-ie
#open 2023-03-15-16-56-36
#fields ts src_mac dst_mac service pdu_type cmd node_type node_id connection_info src_node_number number ts_end
#types time string string string string string string string int string string string int time
1667903833.066101 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control select - - - - 0x0001 61 1667903833.134207
1667903833.065821 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control scan - - - - 0x0001 48 1667903833.129023
1667903833.064742 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control connectAck - - - - 0x0001 61 1667903833.133590
1667903833.065511 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control connect - - - 0x0001 62 1667903833.134085
1667903833.067818 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control nTNTest - - - - 0x0001 53 1667903833.131018
1667903833.068939 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control dummy - - - 0x0001 57 1667903833.133957
1667903833.065083 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control collect - - - - 0x0001 61 1667903833.133231
1667903833.064936 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control launch - - - - 0x0001 40 1667903833.132990
1667903833.066240 00:11:11:11:11:11 00:00:00:00:01 cclink_ie_control token - - - - 0x0001 57 1667903833.133351
#close 2023-03-15-16-56-36
```

### When TSN frame is contained

It also outputs as `cclink-ie-tsn.log`.

| Field | Type | Description |
| --- | --- | --- |
| ts | time | timestamp of the first communication |
| src_mac | string | source MCA address |
| dst_mac | string | destination MCA address |
| protocol | string | protocol name |
| pdu_type | string | PDU type |
| pdu_choice | string | name of Protocol Data Unit service |
| node_type | string | node type |
| device_type | string | model type |
| function_name | string | function type |
| number | int | number of packet occurrence |
| ts_end | time | Timestamp of the last communication |

An example of `cclink-ie-tsn.log` is as follows:
```
#separator \x09
#set_separator	,
#empty_field	(empty)
#unset_field	-
#path	cclink-ie-tsn
#open	2023-10-20-08-20-36
#fields	ts	src_mac	dst_mac	protocol	pdu_type	pdu_choice	node_type	device_type	function_name	number	ts_end
#types	time	string	string	string	string	string	string	string	string	int	time
1697605189.166718	00:0c:29:a8:c1:f0	80:22:a7:83:f9:7e	cclink_ie_tsn&field	acyclic	acyclicTestDataAck	master station	-	-	30	1697605189.169635
1697605738.834423	00:0c:29:a8:c1:f0	b4:b5:2f:76:cb:e4	cclink_ie_tsn	acyclic	acyclicTestData	master station	-	-	30	1697605738.837371
1697605817.307274	00:0c:29:a8:c1:f0	00:4e:01:c5:21:8f	cclink_ie_tsn	acyclic	acyclicData	-	-	-	30	1697605817.309732
1697605847.495273	28:e9:8e:75:95:a7	28:e9:8e:18:71:58	cclink_ie_tsn	acyclic	acyclicDetectionAck Ver.0	slave station	personal computer	srwcl	30	1697605847.499091
1697605894.366325	28:e9:8e:75:95:a7	28:e9:8e:18:71:58	cclink_ie_tsn	cyclic	cyclicS/cyclicSs	-	-	-	30	1697605894.369247
1697605826.702719	00:0c:29:5f:70:ce	08:00:27:b9:d0:0a	cclink_ie_tsn	acyclic	acyclicDetection Ver.0	-	-	-	30	1697605826.705461
1697605885.372366	28:e9:8e:18:71:58	28:e9:8e:75:95:a7	cclink_ie_tsn	cyclic	cyclicM/cyclicMs	-	-	-	30	1697605885.375176
1697605875.249707	28:e9:8e:18:71:58	ff:ff:ff:ff:ff:ff	cclink_ie_tsn	acyclic	acyclicPriority	-	-	-	30	1697605875.252467
1697605857.305008	28:e9:8e:75:95:a7	28:e9:8e:18:71:58	cclink_ie_tsn	acyclic	acyclicDetectionAck Ver.1	slave station	digital I/O	srwcvpdiIR	30	1697605857.309105
1697605837.472867	28:e9:8e:18:71:58	08:00:27:b9:d0:0b	cclink_ie_tsn	acyclic	acyclicDetection Ver.0	-	-	-	30	1697605837.475716
#close	2023-10-20-08-20-36
```

## Related Software

This plug-in is used by [OsecT](https://github.com/nttcom/OsecT).
